#网通信协议

##1.广播与广播域概述
- 广播：将广播地址作为目的地址的数据帧
- 广播域：网络中能接收到同一个广播所有节点的集合
- MAC地址广播：广播地址为&nbsp;&nbsp;<font color=red size=4>FF-FF-FF-FF-FF-FF</font>
- IP广播地址：广播IP地址为IP地址网段的广播地址


##2.IP协议
###IP地址
>主机唯一标示，保证主机间的正常通讯的一种网络编码，用来确定网络中一个节点。
IP地址由32位二进制数组成，为了便于记忆，将32位二进制数划分为每八位一组，再将每八位转换为十进制。
例如：
$(11010010.01001001.10001100.00000110)_2$&nbsp;$\Rightarrow$&nbsp;$210.73.140.6$


###IP地址的组成
- Ip地址由两部分组成
网络部分(Network)
主机部分(Host)</br>
<font color=red>```192.168.0```</font><font color=green>```.25```</font>
&nbsp;&nbsp;&nbsp;&nbsp;<font color=red>网络部分</font>&nbsp;&nbsp;<font color=green>主机部分</font>


###IP地址的分类
- IP地址分为A、B、C、D、E五类，每一类有不同划分规则
IP地址跟A、B、C、D、E分类没有任何关系，原因是子网掩码，IP地址的主机位和网络位依靠子网掩码划分。
  - <font color=blue>__A类地址__</font>
  前八位第一位必须为<font color=red>__0__</font>，所以A类地址的范围就是$00000000$到$01111111$，因此换为十进制就是$0$~$127$。<font color=green>__但是127网段中127.0.0.1是本地回环网卡，整个网段都被占用。__</font>
  子网掩码：```255.0.0.0```
  网段数：只有126个网段。
  主机数：$2^{24}-2=16777216-2=16777214$
  - <font color=blue>__B类地址__</font>
  前八位的前两位必须是font color=red>__10__</font>，所以B类地址的范围就是$10000000$到$10111111$,因此转换为十进制就是$128$~$191$。
  子网掩码：```255.255.0.0```
  网段数：$2^{14}=16384$ 
  主机数：$2^{16}-2=65536-2=65534$
  - <font color=blue>__C类地址__</font>
  前八位的前三位必是<font color=red>__110__</font>，所以C类地址的范围是$11000000$到$11011111$，因此转换为十进制就是$192$~$233$
  子网掩码：```255.255.255.0```
  网段数：$2^{21}=2097152$
  主机数：$2^8-2=256-2=254$
  - <font color=blue>__D类地址__</font>
   前八位的前四位必须是<font color=red>__1110__</font>，所以D地址的范围是$11100000$到$11101111$，因此转换为十进制就是$224$~$239$，D类地址是广播地址,只有特殊广播网卡才能使用。
  - <font color=blue>__E类地址__</font>
  前五位必须是<font color=red>__1111__</font>，所以E类地址的范围就是$11110000$到$11111111$，因此转换为十进制是$240$~$255$，E类地址是备用地址，未使用。


- A、B、C三类IP地址的组成
网络部分(Network)
主机部分(Host)
![IP地址分类](b830ee40-b0fc-4c30-8061-221a62783ee3_128_files/IP_u5730_u5740_u5206_u7C7B.png "IP地址分类")


 - 公有IP地址用于Internet
 - 私有IP地址是企业用户在内部网络中使用
 - 私有地址不能再Internet上使用
 - 私有地址包括3组


    |A类|<font color=red>$10$</font>.$0.0.0$~<font color=red>$10$</font>.$255.255.255$|1个网段|
    |:--:|:-- |:--- |
    |B类|<font color=red>$172.16$</font>.$0.0$~<font color=red>$172.31$</font>.$255.255$|16个网段|
    |C类|<font color=red>$192.168$</font>.$0.0$~<font color=red>$192.168$</font>.$255.255$|256个网段|


###子网掩码
- 规则：
  - 子网掩码必须是连续的1
  - 子网掩码必须和IP地址同时出现
  - 子网掩码中1对应网络位，0对应主机位。
- IP地址和子网掩码做“逻辑与”运算得到网络地址
  - 0和任何数相与都等于0
  - 1和任何数相与都等于任何数本身
  ```11000000```.```10101000```.```00000001```.```10111101```  IP地址
  ```11111111```.```11111111```.```11111111```.```00000000```  子网掩码
  ```11000000```.```10101000```.```00000001```.```00000000```  二进制
  `192`.`168`.`1`.`192`十进制


- 网络中不同主机之间通讯
  - 同网段主机之间的通讯，将数据直接发送给另一台主机
    源主机的网络地址 $=$ 目标主机的网络地址
  - 不同网段主机之间的通讯，将数据发送给网关进行转发
    源主机的网络地址 $\neq$ 目标主机的网络地址
  - 子网掩码(Netmask)可以区分IP地址的网络地址部分


- A、B、C三类地址的默认子网掩码
  - A类：255.0.0.0
  - B类：255.255.0.0
  - C类：255.255.255.0


####子网划分
- 子网划分的原因
   - 满足不同网络对IP地址的需求
   - 实现网络的层次性
   - 节省IP地址


- IP地址分类
 - 有类地址
   有类别，标准子网掩码。不认识VLSM变长子网掩码。
 - 无类地址
   可以识别VLSM变长子网掩码。


- 子网划分的原理
   - 将192.168.1.0/24划分为4个小网段
   将主机位划到网络位，不认识VLSM子网掩码
- 可变长子网掩码(VLSM)
   - VLSM允许把子网继续划分为更小的子网


VLSM子网掩码：
<font color=green>11111111.11111111.11111111</font>.<font color=red>00000000</font>
网络位24位，主机位8位。192.168.1.0/24与子网掩码255.255.255.0相与。
<font color=green>11111111.11111111.11111111.11</font><font color=red>000000</font>
网络位向主机位借2位，网络位26位，主机位6位。子网掩码变为255.255.255.0。私有IP变为192.168.1.0/26。


- 子网掩码计算公式
需要把IP和子网掩码转为二进制
  - 网络地址：把IP地址与子网掩码相与，得出就是网络地址
  - 广播地址：子网掩码中有几个0，就把IP地址的后几位换成1
  - 子网数：有效子网掩码中，有n个1，子网数就是2的n次方
  - 主机数：有效子网掩码中，有n个0，主机数就是2的n次方减2


- 子网掩码表格


|子网掩码|1的个数|子网数|主机数|
|:--- |:---:|:----:|:---:|
|255.255.255.0|/24|1|$255-2$|
|255.255.255.128|/25|2|$128-2$|
|255.255.255.192|/26|4|$64-2$|
|255.255.255.224|/27|8|$32-2$|
|255.255.255.240|/28|16|$16-2$|
|255.255.255.248|/29|32|$8-2$|
|255.255.255.252|/30|64|$4-2$|


##数据包格式
- 数据包包头有IP包头，TCP协议数据格式。
###IP包头
![IP包头格式](b830ee40-b0fc-4c30-8061-221a62783ee3_128_files/IP_u5305_u5934_u683C_u5F0F.PNG "IP包头格式")
- IP包头长度为20字节（160个二进制位），可选项可以增加包头长度，最大60字节。
  - 版本：版本字段，IP v4。
  - 部首长度：IP包头部长度，因为长度可变，因此需要定义。
  - 优先级与服务类型：优先级与服务类型，提供3层的QoS。
  - 总长度：IP数据总长度，所以最大长度为$2^{16}=65536$。
  - 标识符、标志、段偏移量：上层来的数据到IP层会被分片，这几个字段用来对数据包进行标识，使数据到达目的端重组时，不会乱序
  - TTL：生命周期字段，单位是跳。经过一个路由器TTL值减去1，为0时，数据包丢弃。为了防止一个数据包在网络中无限循环下去。
  - 协议号：协议字段，用来标识封装的上层数据是UDP还是TCP，UDP是17，TCP是6。
  - 首部校验和：用来检验数据包是否发生错误。


###TCP协议数据格式
- TCP包头长度为20字节，可选项可以增加包头长度。
![TCP数据协议格式](b830ee40-b0fc-4c30-8061-221a62783ee3_128_files/TCP_u6570_u636E_u534F_u8BAE_u683C_u5F0F.PNG "TCP数据协议格式")
 - SYN：发送请求包（信包）
 - ASK：回应请求包（回应包）
- TCP协议工作机制
![TCP协议工作机制](b830ee40-b0fc-4c30-8061-221a62783ee3_128_files/TCP_u534F_u8BAE_u5DE5_u4F5C_u673A_u5236.PNG "TCP协议工作机制")
 - A向B发送包，在TCP包中有SYN信包（<font color=red>序列号是X</font>），B就会知道A是发送请求连接。
 - B向A回复ACK回应包（<font color=red>序列号是Y</font>），并在SYN信包中<font color=green>序列号X+1</font>，表明B收到A发送的SYN信包。
 - A收到B的ACK回应包后，查看ACK回应包确认号，并更改回应包ACK（<font color=green>序列号y+1</font>)。


- SYN的漏洞
 - SYN拒绝服务攻击（Dos攻击）
 A向B发起连接，B回应后等待A再次发送，但A不再发送，B会空出一部分运算性能等待，这段时间无法回应其他主机的请求。
 - 分布式攻击（DDos攻击）
 通过软件把源IP修改成随机IP，或劫持大量主机向B进行Dos攻击。


###UDP协议数据格式
![UDP协议数据格式](b830ee40-b0fc-4c30-8061-221a62783ee3_128_files/UDP_u6570_u636E_u534F_u8BAE_u683C_u5F0F.PNG "UDP协议数据格式")
- UDP比TCP快：
UDP不需要三次握手
UDP包头长度定长

