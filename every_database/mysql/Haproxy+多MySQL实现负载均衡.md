# Haproxy+多台MySQL从服务器(Slave) 实现负载均衡

#### 1. 架构

本系统采用MySQL一主多从模式设计，即1台 MySQL“主”服务器(Master)+多台“从”服务器(Slave)，“从”服务器之间通过Haproxy进行负载均衡，对外只提供一个访问IP，当程序需要访问多台"从"服务器时，只需要访问Haproxy，再由Haproxy将请求分发到各个数据库节点。 



我们的程序可以有俩个数据源(DataSourceA,DataSourceB)，一个(DataSourceA)直接连接主库，另外一个(DataSourceB)连接Haproxy，当需要写入操作时可以使用DataSourceA，读取时使用DataSourceB

设计图如下连接：

```
https://img-blog.csdn.net/20150908163713641?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center
```



 看到这里大家可能会有一个疑问，这个问题就是主从数据库之间数据同步延时的问题！

 因为大多数使用MySQL主从同步数据都是异步的，也就是说当主库的数据发生变化时并不能立即的更新从库，这么做的目的也是为了更好的性能，那么设想一下，当用户新增一条记录后立刻去从库查询，可能并不能查到刚刚新增的数据，这岂不是很脑裂的问题~~~



然而实际情况并不应该是这样的，我们也不应该这样去设计程序，我们就拿一个类似于CSND博客管理的系统来说，假设一个“博客系统”只有俩部分， 一部分是博客管理后台，用户可以在后台新增，编辑，删除博客。另一部分是门户网站，负责展示所有用户的博客信息，相对于这样一个系统来说， 后台管理模块对数据库的操作压力不是很大，相反门户网站读取博客信息对数据库的压力很大，这也式一般互联网产品的特点，而且最重要的一点是系统可以接受主从同步数据带来的延迟，也就是说当用户在后台新增一条博客时，前台门户网站并不能立即查询到这条信息。一般都是再过一段时间后才会出现在首页，因为大多数系统都有缓存设置，这样正好给主从同步延迟带来时间。 



接着说上面的问题，有的同学可能会有这样的疑问，就是后台用户在新增一条记录后，一般都是立即查询返回博客列表，按照上面说的岂不是查询不到~~~，我觉得这个问题可以这么解决：

 1、后台用户在进行 新增，查询，编辑，删除等操作时直接连接主库，这样无论什么操作都是实时的，因为后台操作对数据库的压力不是很大，所以读写全部连接主库应该没什么问题！ 

 2、门户网站查询博客列表时从 “从库集群中查询“，通过负载均衡技术，解决了扩展性，高可用性等问题，同时门户网站首页也不需要实时查询主库中的数据，因为网站本身一般都有缓存，也不是实时的。 



上面的架构设计只是抛砖引玉，大家有什么好想法也可以相互交流~ 本文重点介绍的内容有二点：

 1、如何使用Haproxy给MySQL做负载均衡，提供相关的配置说明，健康检查等等。 

2、当程序通过连接Haproxy代理之后，如何解决程序中连接池长连接失效的问题。



#### 4.配置haproxy及mysql